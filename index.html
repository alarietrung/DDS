<!DOCTYPE html>
<html lang="vi" class="light"> <!-- Default to light, JS will handle theme switching -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MITEN - Ph√¢n Lo·∫°i R√°c Th√¥ng Minh</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Be Vietnam Pro -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Styles */
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* Animations */
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in-animation { animation: pop-in 0.5s ease-out forwards; }
        @keyframes scan-line {
            0% { top: 0%; }
            100% { top: 100%; }
        }
        .scan-line-animation { animation: scan-line 2s linear infinite; }
        
        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Correct Dark Mode Icon Toggling */
        .dark .sun-icon { display: inline-block; }
        .dark .moon-icon { display: none; }
        html:not(.dark) .sun-icon { display: none; }
        html:not(.dark) .moon-icon { display: inline-block; }
    </style>
    <script>
        // Tailwind config
        tailwind.config = {
          darkMode: 'class', // Enable class-based dark mode
        }
        
        // Set theme on initial load to prevent FOUC (Flash of Unstyled Content)
        function applyTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
        }
        applyTheme();
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">

    <!-- Main App Container -->
    <div id="app-container" class="max-w-md mx-auto h-screen bg-white dark:bg-black flex flex-col shadow-2xl">
        
        <!-- App Screens -->
        <main id="main-content" class="flex-grow overflow-y-auto no-scrollbar pb-20">
            <!-- Onboarding Screen -->
            <div id="onboarding-screen" class="h-full flex flex-col p-6 text-center justify-between">
                <div class="absolute top-8 left-1/2 -translate-x-1/2 flex items-center space-x-2">
                    <svg class="w-8 h-8 text-green-600" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM16.25 15.34C15.83 15.93 15.06 16.21 14.27 15.99L12 15.25L9.73 15.99C8.94 16.21 8.17 15.93 7.75 15.34C7.33 14.75 7.33 13.9 7.82 13.26L9.89 10.5L8.5 8.5C8.07 7.98 8.16 7.15 8.71 6.71C9.26 6.27 10.09 6.35 10.5 6.88L12 8.75L13.5 6.88C13.91 6.35 14.74 6.27 15.29 6.71C15.84 7.15 15.93 7.98 15.5 8.5L14.11 10.5L16.18 13.26C16.67 13.9 16.67 14.75 16.25 15.34Z"/>
                    </svg>
                    <span class="text-2xl font-bold text-gray-800 dark:text-gray-200">MITEN</span>
                </div>
                <div class="flex-grow flex flex-col justify-center items-center">
                    <div id="onboarding-carousel" class="w-full">
                        <div class="onboarding-slide"><img src="https://placehold.co/300x300/A7F3D0/14532D?text=üåç" class="mx-auto mb-6 rounded-full"><h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">Ph√¢n lo·∫°i r√°c d·ªÖ d√†ng</h2><p class="text-gray-600 dark:text-gray-400">Qu√©t r√°c th·∫£i c·ªßa b·∫°n v√† ƒë·ªÉ AI c·ªßa ch√∫ng t√¥i h∆∞·ªõng d·∫´n b·∫°n.</p></div>
                        <div class="onboarding-slide hidden"><img src="https://placehold.co/300x300/FDE68A/B45309?text=üéÅ" class="mx-auto mb-6 rounded-full"><h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">T√≠ch ƒëi·ªÉm ƒë·ªïi qu√† h·∫•p d·∫´n</h2><p class="text-gray-600 dark:text-gray-400">M·ªói l·∫ßn ph√¢n lo·∫°i ƒë√∫ng, b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c ƒëi·ªÉm th∆∞·ªüng gi√° tr·ªã.</p></div>
                        <div class="onboarding-slide hidden"><img src="https://placehold.co/300x300/BFDBFE/1E40AF?text=ü§ù" class="mx-auto mb-6 rounded-full"><h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">Chung tay v√¨ ƒê·ªìng Nai xanh</h2><p class="text-gray-600 dark:text-gray-400">C√πng c·ªông ƒë·ªìng x√¢y d·ª±ng m·ªôt m√¥i tr∆∞·ªùng s·ªëng b·ªÅn v·ªØng.</p></div>
                    </div>
                    <div id="onboarding-dots" class="flex justify-center space-x-2 mt-8"><span class="dot active h-2 w-2 bg-green-600 rounded-full"></span><span class="dot h-2 w-2 bg-gray-300 dark:bg-gray-600 rounded-full"></span><span class="dot h-2 w-2 bg-gray-300 dark:bg-gray-600 rounded-full"></span></div>
                </div>
                <button id="onboarding-next-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-green-700 transition-colors">Ti·∫øp theo</button>
            </div>

            <div id="login-screen" class="hidden h-full flex flex-col p-6 text-center justify-center items-center">
                <div class="flex items-center space-x-3 mb-4">
                    <svg class="w-12 h-12 text-green-600" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM16.25 15.34C15.83 15.93 15.06 16.21 14.27 15.99L12 15.25L9.73 15.99C8.94 16.21 8.17 15.93 7.75 15.34C7.33 14.75 7.33 13.9 7.82 13.26L9.89 10.5L8.5 8.5C8.07 7.98 8.16 7.15 8.71 6.71C9.26 6.27 10.09 6.35 10.5 6.88L12 8.75L13.5 6.88C13.91 6.35 14.74 6.27 15.29 6.71C15.84 7.15 15.93 7.98 15.5 8.5L14.11 10.5L16.18 13.26C16.67 13.9 16.67 14.75 16.25 15.34Z"/></svg>
                    <h1 class="text-5xl font-bold text-gray-800 dark:text-gray-100">MITEN</h1>
                </div>
                <p class="text-gray-600 dark:text-gray-400 mt-2 mb-12">Ch√†o m·ª´ng b·∫°n tr·ªü l·∫°i!</p>
                <div class="w-full space-y-4"><button id="login-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center space-x-2 hover:bg-green-700 transition-colors"><span>ƒêƒÉng nh·∫≠p v·ªõi t∆∞ c√°ch Kh√°ch</span></button><p class="text-xs text-gray-400 dark:text-gray-500 mt-4">ƒê√¢y l√† b·∫£n demo. Nh·∫•n ƒë·ªÉ ti·∫øp t·ª•c.</p></div>
            </div>

            <div id="home-screen" class="hidden p-6"><div class="flex justify-between items-center mb-6"><div><p class="text-gray-500 dark:text-gray-400">Xin ch√†o,</p><h1 id="user-name" class="text-2xl font-bold text-gray-800 dark:text-gray-100">An Nguy·ªÖn</h1></div><div class="flex items-center bg-amber-100 dark:bg-amber-900/50 text-amber-800 dark:text-amber-300 font-bold px-4 py-2 rounded-full"><i data-lucide="gem" class="w-5 h-5 mr-2"></i><span id="user-points">1250</span></div></div><div class="bg-gradient-to-br from-green-500 to-emerald-600 text-white p-6 rounded-2xl mb-6 shadow-lg"><p class="text-lg">Th·ª≠ th√°ch tu·∫ßn</p><h2 class="text-2xl font-bold my-1">Chuy√™n gia t√°i ch·∫ø nh·ª±a</h2><p class="text-green-100 mb-4">Ph√¢n lo·∫°i 20 v·∫≠t ph·∫©m nh·ª±a ƒë·ªÉ nh·∫≠n 100 ƒëi·ªÉm th∆∞·ªüng!</p><div class="w-full bg-green-400/50 rounded-full h-2.5"><div id="challenge-progress" class="bg-white rounded-full h-2.5" style="width: 45%"></div></div><p id="challenge-progress-text" class="text-right text-sm mt-1">9/20 v·∫≠t ph·∫©m</p></div><div><h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4">Nhi·ªám v·ª• h√†ng ng√†y</h3><div class="space-y-3"><div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl flex items-center justify-between"><div class="flex items-center"><div class="bg-blue-200 dark:bg-blue-900/50 p-2 rounded-lg mr-4"><i data-lucide="scan-line" class="w-6 h-6 text-blue-700 dark:text-blue-300"></i></div><div><p class="font-semibold text-gray-800 dark:text-gray-200">Qu√©t 5 m√≥n r√°c</p><p class="text-sm text-gray-500 dark:text-gray-400">+20 ƒëi·ªÉm</p></div></div><span class="text-gray-500 dark:text-gray-400 font-medium">3/5</span></div><div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl flex items-center justify-between"><div class="flex items-center"><div class="bg-rose-200 dark:bg-rose-900/50 p-2 rounded-lg mr-4"><i data-lucide="newspaper" class="w-6 h-6 text-rose-700 dark:text-rose-300"></i></div><div><p class="font-semibold text-gray-800 dark:text-gray-200">Ph√¢n lo·∫°i 1kg gi·∫•y</p><p class="text-sm text-gray-500 dark:text-gray-400">+50 ƒëi·ªÉm</p></div></div><span class="text-green-600 dark:text-green-400 font-medium">Ho√†n th√†nh</span></div></div></div></div>

            <div id="scan-screen" class="hidden h-full flex flex-col bg-black text-white"><div class="p-4 flex justify-between items-center"><button id="close-scan-btn"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="font-bold">Qu√©t R√°c</h2><div class="w-6"></div></div><div id="scanner-view" class="flex-grow flex flex-col items-center justify-center p-4 relative overflow-hidden"><p class="mb-4 text-center">H∆∞·ªõng camera v√†o m·ªôt m√≥n r√°c.<br>(Trong b·∫£n demo, h√£y ch·ªçn m·ªôt lo·∫°i r√°c b√™n d∆∞·ªõi)</p><div class="w-full max-w-xs h-64 bg-gray-800 rounded-2xl border-2 border-dashed border-gray-500 flex items-center justify-center relative"><i data-lucide="scan" class="w-16 h-16 text-gray-500"></i><div id="scan-line" class="hidden absolute left-0 w-full h-1 bg-green-400/50 shadow-[0_0_10px_theme(colors.green.400)] scan-line-animation"></div></div></div><div class="p-4 bg-gray-900"><h3 class="text-center font-semibold mb-4">Ch·ªçn ƒë·ªÉ m√¥ ph·ªèng qu√©t:</h3><div class="grid grid-cols-3 gap-4"><button class="scan-sim-btn bg-gray-800 p-3 rounded-lg text-center" data-type="plastic"><p class="text-3xl">üß¥</p><p class="text-sm mt-1">Chai nh·ª±a</p></button><button class="scan-sim-btn bg-gray-800 p-3 rounded-lg text-center" data-type="paper"><p class="text-3xl">üì¶</p><p class="text-sm mt-1">H·ªôp gi·∫•y</p></button><button class="scan-sim-btn bg-gray-800 p-3 rounded-lg text-center" data-type="organic"><p class="text-3xl">üçé</p><p class="text-sm mt-1">H·ªØu c∆°</p></button></div></div></div>

            <div id="rewards-screen" class="hidden p-6"><h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-2">ƒê·ªïi Qu√†</h1><p class="text-gray-500 dark:text-gray-400 mb-6">D√πng ƒëi·ªÉm c·ªßa b·∫°n ƒë·ªÉ nh·∫≠n nh·ªØng ∆∞u ƒë√£i h·∫•p d·∫´n!</p><div class="bg-amber-100 dark:bg-amber-900/50 p-4 rounded-xl flex justify-between items-center mb-6"><span class="font-semibold text-amber-800 dark:text-amber-300">ƒêi·ªÉm c·ªßa b·∫°n</span><span id="rewards-points" class="font-bold text-xl text-amber-900 dark:text-amber-200">1250</span></div><div id="rewards-list" class="grid grid-cols-2 gap-4"></div></div>

            <div id="community-screen" class="hidden p-6"><h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-6">C·ªông ƒê·ªìng</h1><div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-4"><h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-gray-200 text-center">B·∫£ng X·∫øp H·∫°ng Tu·∫ßn (Ph∆∞·ªùng Tr·∫£ng D√†i)</h3><div id="leaderboard" class="space-y-3"></div></div></div>

            <div id="profile-screen" class="hidden p-6">
                <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">T√†i Kho·∫£n</h1><button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200"><i data-lucide="sun" class="sun-icon w-5 h-5"></i><i data-lucide="moon" class="moon-icon w-5 h-5"></i></button></div>
                <div class="flex flex-col items-center mb-8"><img src="https://placehold.co/100x100/A7F3D0/14532D?text=A" class="rounded-full mb-4" alt="User Avatar"><h2 id="profile-name" class="text-2xl font-bold text-gray-800 dark:text-gray-100">An Nguy·ªÖn</h2><p id="profile-join-date" class="text-gray-500 dark:text-gray-400">Tham gia th√°ng 7, 2025</p></div>
                <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-2xl mb-6"><h3 class="font-bold text-gray-800 dark:text-gray-200 mb-4">T√°c ƒë·ªông c·ªßa b·∫°n</h3><div class="grid grid-cols-3 gap-4 text-center"><div class="flex flex-col items-center"><i data-lucide="recycle" class="w-8 h-8 text-green-600 dark:text-green-400 mb-1"></i><p class="text-lg font-bold text-gray-800 dark:text-gray-200">15 kg</p><p class="text-sm text-gray-600 dark:text-gray-400">T√°i ch·∫ø</p></div><div class="flex flex-col items-center"><i data-lucide="zap" class="w-8 h-8 text-blue-600 dark:text-blue-400 mb-1"></i><p class="text-lg font-bold text-gray-800 dark:text-gray-200">25 kWh</p><p class="text-sm text-gray-600 dark:text-gray-400">Ti·∫øt ki·ªám</p></div><div class="flex flex-col items-center"><i data-lucide="award" class="w-8 h-8 text-amber-500 dark:text-amber-400 mb-1"></i><p class="text-lg font-bold text-gray-800 dark:text-gray-200">3</p><p class="text-sm text-gray-600 dark:text-gray-400">Huy hi·ªáu</p></div></div></div>
                <div class="space-y-2">
                    <a href="#" class="flex items-center justify-between p-4 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"><div class="flex items-center"><i data-lucide="history" class="w-5 h-5 mr-3 text-gray-500 dark:text-gray-400"></i><span class="font-medium text-gray-800 dark:text-gray-200">L·ªãch s·ª≠ ho·∫°t ƒë·ªông</span></div><i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i></a>
                    <a href="#" class="flex items-center justify-between p-4 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"><div class="flex items-center"><i data-lucide="bell" class="w-5 h-5 mr-3 text-gray-500 dark:text-gray-400"></i><span class="font-medium text-gray-800 dark:text-gray-200">Th√¥ng b√°o</span></div><i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i></a>
                    <a href="#" class="flex items-center justify-between p-4 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"><div class="flex items-center"><i data-lucide="help-circle" class="w-5 h-5 mr-3 text-gray-500 dark:text-gray-400"></i><span class="font-medium text-gray-800 dark:text-gray-200">Trung t√¢m tr·ª£ gi√∫p</span></div><i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i></a>
                </div>
                <button id="logout-btn" class="w-full mt-6 bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-300 font-bold py-3 px-4 rounded-xl hover:bg-red-200 dark:hover:bg-red-900/80 transition-colors">ƒêƒÉng xu·∫•t</button>
            </div>
        </main>

        <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white/80 dark:bg-black/80 backdrop-blur-sm border-t border-gray-200 dark:border-gray-800"><div class="flex justify-around items-center h-16"><button class="nav-btn p-2 text-green-600" data-target="home-screen"><i data-lucide="home" class="w-7 h-7"></i></button><button class="nav-btn p-2 text-gray-500 dark:text-gray-400" data-target="rewards-screen"><i data-lucide="gift" class="w-7 h-7"></i></button><button id="scan-btn" class="transform -translate-y-6"><div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center text-white shadow-lg"><i data-lucide="scan-line" class="w-8 h-8"></i></div></button><button class="nav-btn p-2 text-gray-500 dark:text-gray-400" data-target="community-screen"><i data-lucide="users" class="w-7 h-7"></i></button><button class="nav-btn p-2 text-gray-500 dark:text-gray-400" data-target="profile-screen"><i data-lucide="user-circle" class="w-7 h-7"></i></button></div></nav>

        <div id="scan-result-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50"><div id="scan-result-card" class="bg-white dark:bg-gray-800 rounded-2xl p-6 text-center w-full max-w-sm"></div></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & DATA ---
            const state = { currentPage: 'onboarding-screen', user: { name: 'An Nguy·ªÖn', points: 1250, joinDate: 'th√°ng 7, 2025', challengeProgress: 9, challengeTotal: 20 }, onboarding: { currentIndex: 0, slides: document.querySelectorAll('.onboarding-slide'), dots: document.querySelectorAll('#onboarding-dots .dot') } };
            const rewardsData = [ { partner: 'The Coffee House', title: 'Gi·∫£m 20,000ƒë', points: 2000, img: 'https://placehold.co/150x100/B91C1C/FFFFFF?text=Coffee' }, { partner: 'Circle K', title: 'Voucher 10,000ƒë', points: 1000, img: 'https://placehold.co/150x100/F59E0B/FFFFFF?text=Store' }, { partner: 'B√°ch H√≥a Xanh', title: 'Gi·∫£m 25,000ƒë', points: 2500, img: 'https://placehold.co/150x100/10B981/FFFFFF?text=Green' }, { partner: 'Ph√∫c Long', title: 'Mi·ªÖn ph√≠ 1 ly tr√†', points: 5000, img: 'https://placehold.co/150x100/059669/FFFFFF?text=Tea' } ];
            const leaderboardData = [ { name: 'B·∫£o Tr√¢n', points: 2580, avatar: 'https://placehold.co/40x40/FBCFE8/9D174D?text=B' }, { name: 'B·∫°n', points: state.user.points, avatar: 'https://placehold.co/40x40/A7F3D0/14532D?text=A', isUser: true }, { name: 'Minh Khang', points: 1150, avatar: 'https://placehold.co/40x40/BFDBFE/1E40AF?text=M' }, { name: 'Gia H√¢n', points: 980, avatar: 'https://placehold.co/40x40/FDE68A/B45309?text=G' } ];
            const scanResults = { plastic: { name: 'Chai Nh·ª±a PET', instruction: 'B·ªè v√†o t√∫i <strong>R√ÅC T√ÅI CH·∫æ</strong>', points: 5, icon: '‚ôªÔ∏è' }, paper: { name: 'H·ªôp Gi·∫•y Carton', instruction: 'B·ªè v√†o t√∫i <strong>R√ÅC T√ÅI CH·∫æ</strong>', points: 3, icon: '‚ôªÔ∏è' }, organic: { name: 'R√°c H·ªØu C∆°', instruction: 'B·ªè v√†o t√∫i <strong>R√ÅC H·ªÆU C∆†</strong>', points: 2, icon: 'üåø' } };

            // --- DOM ELEMENTS ---
            const mainContent = document.getElementById('main-content');
            const allScreens = mainContent.querySelectorAll('div[id$="-screen"]');
            const navButtons = document.querySelectorAll('.nav-btn');
            const themeToggle = document.getElementById('theme-toggle');

            // --- CORE FUNCTIONS ---
            function navigateTo(screenId) {
                allScreens.forEach(screen => screen.classList.add('hidden'));
                const targetScreen = document.getElementById(screenId);
                targetScreen.classList.remove('hidden');
                targetScreen.classList.add('flex', 'flex-col'); // Base class for layout
                if (!['onboarding-screen', 'login-screen', 'scan-screen'].includes(screenId)) {
                    targetScreen.classList.remove('flex', 'flex-col'); // Remove for screens with static content
                }
                
                navButtons.forEach(btn => {
                    const isActive = btn.dataset.target === screenId;
                    btn.classList.toggle('text-green-600', isActive);
                    btn.classList.toggle('dark:text-green-400', isActive);
                    btn.classList.toggle('text-gray-500', !isActive);
                    btn.classList.toggle('dark:text-gray-400', !isActive);
                });
                state.currentPage = screenId;
                mainContent.scrollTop = 0;
            }

            function updateUI() {
                document.getElementById('user-name').textContent = state.user.name;
                document.getElementById('user-points').textContent = state.user.points;
                document.getElementById('rewards-points').textContent = state.user.points;
                document.getElementById('profile-name').textContent = state.user.name;
                document.getElementById('profile-join-date').textContent = `Tham gia ${state.user.joinDate}`;
                const progress = (state.user.challengeProgress / state.user.challengeTotal) * 100;
                document.getElementById('challenge-progress').style.width = `${progress}%`;
                document.getElementById('challenge-progress-text').textContent = `${state.user.challengeProgress}/${state.user.challengeTotal} v·∫≠t ph·∫©m`;
                leaderboardData.find(u => u.isUser).points = state.user.points;
                leaderboardData.sort((a, b) => b.points - a.points);
                populateLeaderboard();
            }

            function populateRewards() {
                document.getElementById('rewards-list').innerHTML = rewardsData.map(r => `<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden"><img src="${r.img}" alt="${r.partner}" class="w-full h-24 object-cover"><div class="p-3"><p class="font-semibold text-gray-700 dark:text-gray-200 text-sm">${r.partner}</p><p class="text-gray-600 dark:text-gray-400 text-xs mb-2">${r.title}</p><button class="w-full text-sm bg-amber-400 text-amber-900 font-bold py-1.5 rounded-lg hover:bg-amber-500 transition-colors">${r.points} ƒëi·ªÉm</button></div></div>`).join('');
            }

            function populateLeaderboard() {
                document.getElementById('leaderboard').innerHTML = leaderboardData.map((user, index) => {
                    const rank = index + 1;
                    const bgColor = user.isUser ? 'bg-green-100 dark:bg-green-900/50' : 'bg-gray-100 dark:bg-gray-700/50';
                    const rankColor = rank === 1 ? 'text-amber-500' : rank === 2 ? 'text-gray-500' : rank === 3 ? 'text-orange-700' : 'text-gray-400';
                    return `<div class="${bgColor} p-3 rounded-lg flex items-center space-x-4"><span class="font-bold text-lg w-6 text-center ${rankColor}">${rank}</span><img src="${user.avatar}" alt="avatar" class="w-10 h-10 rounded-full"><div class="flex-grow"><p class="font-semibold text-gray-800 dark:text-gray-200">${user.name}</p></div><span class="font-bold text-green-700 dark:text-green-400">${user.points}</span></div>`;
                }).join('');
            }

            function showScanResult(type) {
                const result = scanResults[type];
                if (!result) return;
                const modal = document.getElementById('scan-result-modal');
                document.getElementById('scan-result-card').innerHTML = `<p class="text-6xl mb-4">${result.icon}</p><h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">${result.name}</h2><p class="text-gray-600 dark:text-gray-400 mb-4">${result.instruction}</p><p class="text-lg font-bold text-amber-600 dark:text-amber-400 mb-6">+${result.points} ƒëi·ªÉm</p><button id="confirm-scan-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-green-700 transition-colors">X√°c nh·∫≠n</button>`;
                modal.classList.remove('hidden');
                modal.querySelector('#scan-result-card').classList.add('pop-in-animation');
                document.getElementById('confirm-scan-btn').addEventListener('click', () => {
                    state.user.points += result.points;
                    if (type === 'plastic') state.user.challengeProgress++;
                    updateUI();
                    modal.classList.add('hidden');
                    modal.querySelector('#scan-result-card').classList.remove('pop-in-animation');
                }, { once: true });
            }

            function handleOnboarding() {
                const { slides, dots, currentIndex } = state.onboarding;
                const nextBtn = document.getElementById('onboarding-next-btn');
                slides[currentIndex].classList.add('hidden');
                dots[currentIndex].classList.remove('active', 'bg-green-600');
                dots[currentIndex].classList.add('bg-gray-300', 'dark:bg-gray-600');
                
                if (currentIndex === slides.length - 1) {
                    navigateTo('login-screen');
                    return;
                }
                
                state.onboarding.currentIndex++;
                slides[state.onboarding.currentIndex].classList.remove('hidden');
                dots[state.onboarding.currentIndex].classList.add('active', 'bg-green-600');
                dots[state.onboarding.currentIndex].classList.remove('bg-gray-300', 'dark:bg-gray-600');
                
                if (state.onboarding.currentIndex === slides.length - 1) {
                    nextBtn.textContent = 'B·∫Øt ƒë·∫ßu';
                }
            }

            // --- EVENT LISTENERS ---
            navButtons.forEach(b => b.addEventListener('click', () => navigateTo(b.dataset.target)));
            document.getElementById('scan-btn').addEventListener('click', () => navigateTo('scan-screen'));
            document.getElementById('close-scan-btn').addEventListener('click', () => navigateTo(state.currentPage));
            document.querySelectorAll('.scan-sim-btn').forEach(b => b.addEventListener('click', () => {
                document.getElementById('scan-line').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('scan-line').classList.add('hidden');
                    navigateTo('home-screen');
                    showScanResult(b.dataset.type);
                }, 2000);
            }));
            document.getElementById('onboarding-next-btn').addEventListener('click', handleOnboarding);
            document.getElementById('login-btn').addEventListener('click', () => { navigateTo('home-screen'); updateUI(); });
            document.getElementById('logout-btn').addEventListener('click', () => {
                state.onboarding.currentIndex = 0;
                document.getElementById('onboarding-next-btn').textContent = 'Ti·∫øp theo';
                navigateTo('onboarding-screen');
                // Reset slides and dots for re-onboarding
                state.onboarding.slides.forEach((s, i) => s.classList.toggle('hidden', i !== 0));
                state.onboarding.dots.forEach((d, i) => {
                    d.classList.toggle('active', i === 0);
                    d.classList.toggle('bg-green-600', i === 0);
                    d.classList.toggle('bg-gray-300', i !== 0);
                    d.classList.toggle('dark:bg-gray-600', i !== 0);
                });
            });
            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.theme = isDark ? 'dark' : 'light';
            });

            // --- INITIALIZATION ---
            lucide.createIcons();
            populateRewards();
            updateUI();
            navigateTo('onboarding-screen');
        });
    </script>
</body>
</html>

